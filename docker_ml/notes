# build docker instance
docker-machine create --driver amazonec2 \
	       	      --amazonec2-instance-type p2.xlarge \
		      --amazonec2-vpc-id $AWS_VPC_ID \
		      --amazonec2-access-key $AWS_ACCESS_KEY_ID \
		      --amazonec2-secret-key $AWS_SECRET_ACCESS_KEY \
		      awsgpu01

# SSH into the machine
docker-machine ssh awsgpu01

# set env
docker-machine env awsgpu01
eval `docker-machine env awsgpu01`

# check on instance
docker-machine ip awsgpu01
docker-machine inspect awsgpu01

# build image
docker build -t kcavagnolo/dsci-ml:latest -f Dockerfile.gpu .

# push to repo
docker login
docker push kcavagnolo/dsci-ml:latest

# login to machine directly
docker-machine ssh awsgpu01
nvidia-smi
ls /dev | grep nvidia

# setup notebook
nvidia-docker run \
 -it --rm -d \
 -p 8888:8888 \
 -p 6006:6006 \
 -v /notebooks \
 -v /home/kcavagnolo/ml_fun:/notebooks \
 kcavagnolo/dsci-ml \
 sh -c "jupyter notebook --ip=0.0.0.0 --no-browser --notebook-dir='/notebooks'"

# clean-up
docker stop $(docker ps -a -q)
docker rm $(docker ps -a -q)
docker rmi $(docker images -a -q)

# close and kill instance
docker-machine stop awsgpu01
docker-machine rm -f awsgpu01
